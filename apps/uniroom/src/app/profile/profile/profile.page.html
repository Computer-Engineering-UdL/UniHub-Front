<ion-content [fullscreen]="true" class="page-container">
  <div class="profile-wrapper" *ngIf="user">
    <div class="profile-header">
      <div class="profile-avatar">
        <img [src]="avatarSrc" (error)="onAvatarError()" [alt]="getUserDisplayName()" />
      </div>

      <div class="profile-info">
        <div class="profile-top-section">
          <div class="profile-name-section">
            <h1>{{ getUserDisplayName() }}</h1>
            <ion-badge *ngIf="user.isVerified" color="success" class="verified-badge">
              <ion-icon name="checkmark-circle"></ion-icon>
              {{ 'PROFILE.VERIFIED' | translate }}
            </ion-badge>
          </div>

          <div class="profile-actions">
            <!-- EDIT MODAL -->
            <ion-button
              expand="block"
              color="primary"
              class="edit-profile-btn"
              (click)="openEditModal()">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              {{ 'PROFILE.EDIT_PROFILE' | translate }}
            </ion-button>
            <!-- LOGOUT BUTTON -->
            <ion-button
              color="danger"
              class="logout-button-header"
              (click)="logout()"
              fill="outline">
              <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </div>

        <p class="profile-email">{{ user.email }}</p>

        <div class="profile-meta">
          <span class="meta-item">
            <ion-icon name="person-outline"></ion-icon>
            <span>{{ user.username }}</span>
          </span>
          <span class="meta-item" *ngIf="user.university">
            <ion-icon name="school-outline"></ion-icon>
            <span
              >{{ user.university }} • {{ 'PROFILE.YEAR' | translate: {year: user.yearOfStudy}
              }}</span
            >
          </span>
          <span class="meta-item">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>{{ 'PROFILE.JOINED' | translate }} {{ user.joinedDate }}</span>
          </span>
        </div>

        <div class="profile-role">
          <ion-badge [color]="getRoleBadgeColor(user.role)">
            {{ getRoleTranslationKey(user.role) | translate }}
          </ion-badge>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div class="profile-stats">
      <div class="stat-item">
        <div class="stat-value">{{ stats.posts }}</div>
        <div class="stat-label">{{ 'PROFILE.STATS.POSTS' | translate }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ stats.listings }}</div>
        <div class="stat-label">{{ 'PROFILE.STATS.LISTINGS' | translate }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ stats.helpful }}</div>
        <div class="stat-label">{{ 'PROFILE.STATS.HELPFUL' | translate }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ stats.channels }}</div>
        <div class="stat-label">{{ 'PROFILE.STATS.CHANNELS' | translate }}</div>
      </div>
    </div>

    <!-- NAVIGATION TABS -->
    <div class="profile-tabs">
      <button
        class="tab-button"
        [class.active]="selectedTab === 'overview'"
        (click)="selectTab('overview')">
        {{ 'PROFILE.TABS.OVERVIEW' | translate }}
      </button>
      <button
        class="tab-button"
        [class.active]="selectedTab === 'posts'"
        (click)="selectTab('posts')">
        {{ 'PROFILE.TABS.MY_POSTS' | translate }}
      </button>
      <button
        class="tab-button"
        [class.active]="selectedTab === 'listings'"
        (click)="selectTab('listings')">
        {{ 'PROFILE.TABS.MY_LISTINGS' | translate }}
      </button>
    </div>

    <!-- TABS CONTENT -->
    <div class="profile-content">
      <!-- TAB OVERVIEW -->
      <div *ngIf="selectedTab === 'overview'" class="tab-content">
        <div class="content-grid">
          <!-- INTERESTS -->
          <div class="content-card">
            <div class="card-header-with-action">
              <h2 class="card-title">{{ 'PROFILE.INTERESTS.TITLE' | translate }}</h2>
              <ion-button (click)="openAddInterestModal()" [disabled]="loadingInterests">
                <ion-icon name="add" slot="start"></ion-icon>
                {{ 'PROFILE.INTERESTS.ADD' | translate }}
              </ion-button>
            </div>

            <div class="user-interests-container">
              <ion-spinner *ngIf="loadingInterests"></ion-spinner>

              <ion-chip
                *ngFor="let interest of userInterests"
                color="primary"
                class="user-interest-chip">
                <ion-label>{{ interest.name | interestTranslate:'interest' }}</ion-label>
                <ion-icon
                  name="close-circle"
                  (click)="removeInterest(interest)"
                  [class.disabled]="loadingInterests">
                </ion-icon>
              </ion-chip>

              <div *ngIf="!loadingInterests && userInterests.length === 0" class="empty-interests">
                <ion-icon name="heart-outline"></ion-icon>
                <p>{{ 'PROFILE.INTERESTS.NO_INTERESTS' | translate }}</p>
              </div>
            </div>
          </div>

          <!-- RECENT ACTIVITY -->
          <div class="content-card">
            <h2 class="card-title">{{ 'PROFILE.RECENT_ACTIVITY.TITLE' | translate }}</h2>
            <div class="activity-list">
              <div class="activity-item" *ngFor="let activity of recentActivity">
                <ion-icon [name]="getActivityIcon(activity.type)" class="activity-icon"></ion-icon>
                <div class="activity-content">
                  <p class="activity-text">{{ activity.translationKey | translate }}</p>
                  <span class="activity-time"
                    >{{ getActivityTime(activity.daysAgo) | translate: {count: activity.daysAgo}
                    }}</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MY POSTS -->
      <div *ngIf="selectedTab === 'posts'" class="tab-content">
        <div class="empty-state">
          <ion-icon name="chatbox-ellipses-outline" class="empty-icon"></ion-icon>
          <p>{{ 'PROFILE.NO_POSTS' | translate }}</p>
        </div>
      </div>

      <!-- MY LISTINGS -->
      <div *ngIf="selectedTab === 'listings'" class="tab-content">
        <ion-spinner *ngIf="loadingOffers" class="loading-spinner"></ion-spinner>

        <div *ngIf="!loadingOffers && userOffers.length === 0" class="empty-state">
          <ion-icon name="home-outline" class="empty-icon"></ion-icon>
          <p>{{ 'PROFILE.NO_LISTINGS' | translate }}</p>
        </div>

        <div *ngIf="!loadingOffers && userOffers.length > 0" class="listings-grid">
          <div *ngFor="let offer of userOffers" class="listing-card">
            <div
              class="listing-image"
              [style.background-image]="offer.image ? 'url(' + offer.image + ')' : 'url(https://via.placeholder.com/400x300/e0e0e0/666666?text=No+Image)'">
              <ion-badge
                [color]="offer.status === 'active' ? 'success' : 'medium'"
                class="status-badge">
                {{ ('ROOM.STATUS.' + offer.status.toUpperCase()) | translate }}
              </ion-badge>
            </div>
            <div class="listing-content">
              <h3 class="listing-title">{{ offer.title }}</h3>
              <p class="listing-location">
                <ion-icon name="location-outline"></ion-icon>
                {{ offer.city }}
              </p>
              <div class="listing-details">
                <span class="listing-price">{{ offer.priceFormatted }}</span>
                <span class="listing-area">{{ offer.areaFormatted }} m²</span>
              </div>
              <p class="listing-date">
                <ion-icon name="calendar-outline"></ion-icon>
                {{ offer.posted_date | date:'dd/MM/yyyy' }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>
